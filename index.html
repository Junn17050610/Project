<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prediksi Cuaca Berdasarkan Gambar Awan</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h1>üå§Ô∏è Prediksi Cuaca Berbasis Gambar Awan</h1>
      <p class="subtitle">
        Upload atau capture gambar awan untuk memprediksi cuaca
      </p>

      <div class="error-message" id="errorMessage"></div>

      <div class="upload-section">
        <label for="fileInput" class="upload-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            />
          </svg>
          <div>Upload Gambar</div>
          <input type="file" id="fileInput" accept="image/*" />
        </label>

        <label for="cameraInput" class="capture-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
          <div>Capture dari Kamera</div>
          <input
            type="file"
            id="cameraInput"
            accept="image/*"
            capture="environment"
          />
        </label>
      </div>

      <div class="preview-section" id="previewSection">
        <div class="placeholder">Belum ada gambar yang dipilih</div>
        <img id="imagePreview" style="display: none" />
      </div>

      <button class="predict-btn" id="predictBtn" disabled>
        Prediksi Cuaca
      </button>

      <div class="result-section" id="resultSection">
        <div class="result-icon" id="resultIcon"></div>
        <div class="result-title" id="resultTitle"></div>
        <div class="result-description" id="resultDescription"></div>
        <div class="confidence" id="confidenceText"></div>
      </div>
    </div>

    <script>
      // Konfigurasi
      const API_URL = "https://prediksi-cuaca.up.railway.app/api/predict";

      // Variabel global
      let selectedFile = null;

      // Element references
      const fileInput = document.getElementById("fileInput");
      const cameraInput = document.getElementById("cameraInput");
      const previewSection = document.getElementById("previewSection");
      const imagePreview = document.getElementById("imagePreview");
      const predictBtn = document.getElementById("predictBtn");
      const resultSection = document.getElementById("resultSection");
      const errorMessage = document.getElementById("errorMessage");

      // Event listeners
      fileInput.addEventListener("change", handleImageSelect);
      cameraInput.addEventListener("change", handleImageSelect);
      predictBtn.addEventListener("click", handlePredict);

      /**
       * Handle image selection from file or camera
       */
      function handleImageSelect(e) {
        const file = e.target.files[0];

        if (!file) return;

        // Validasi tipe file
        if (!file.type.startsWith("image/")) {
          showError("File yang dipilih bukan gambar!");
          return;
        }

        // Validasi ukuran file (maksimal 10MB)
        if (file.size > 10 * 1024 * 1024) {
          showError("Ukuran file terlalu besar! Maksimal 10MB");
          return;
        }

        selectedFile = file;

        // Preview gambar
        const reader = new FileReader();
        reader.onload = function (event) {
          imagePreview.src = event.target.result;
          imagePreview.style.display = "block";
          previewSection.querySelector(".placeholder").style.display = "none";
          predictBtn.disabled = false;

          // Hide previous results
          resultSection.classList.remove("show");
          hideError();
        };
        reader.readAsDataURL(file);
      }

      /**
       * Handle prediction
       */
      async function handlePredict() {
        if (!selectedFile) {
          showError("Tidak ada gambar yang dipilih!");
          return;
        }

        // Update button state
        predictBtn.textContent = "Memproses...";
        predictBtn.disabled = true;
        hideError();

        try {
          // Buat FormData
          const formData = new FormData();
          formData.append("image", selectedFile);

          // Kirim request ke backend
          const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
          });

          // Parse response
          const result = await response.json();

          if (result.status === "success") {
            // Tampilkan hasil prediksi
            const isRain = result.data.is_rain;
            const confidence = result.data.confidence;
            const probabilities = result.data.probabilities;

            showResult(isRain, confidence, probabilities);
          } else {
            // Tampilkan error dari backend
            showError(result.message || "Terjadi kesalahan saat prediksi");
          }
        } catch (error) {
          console.error("Error:", error);

          // Handle berbagai jenis error
          if (error.name === "TypeError" && error.message.includes("fetch")) {
            showError(
              "Tidak dapat terhubung ke server. Pastikan backend Flask sudah berjalan di http://localhost:5000"
            );
          } else {
            showError("Error: " + error.message);
          }
        } finally {
          // Reset button state
          predictBtn.textContent = "Prediksi Cuaca";
          predictBtn.disabled = false;
        }
      }

      /**
       * Show prediction result
       */
      function showResult(isRain, confidence, probabilities) {
        const resultIcon = document.getElementById("resultIcon");
        const resultTitle = document.getElementById("resultTitle");
        const resultDescription = document.getElementById("resultDescription");
        const confidenceText = document.getElementById("confidenceText");

        // Reset classes
        resultSection.classList.remove("rain", "no-rain");

        if (isRain) {
          resultSection.classList.add("rain");
          resultIcon.textContent = "üåßÔ∏è";
          resultTitle.textContent = "HUJAN";
          resultDescription.textContent =
            "Prediksi menunjukkan kemungkinan besar akan turun hujan";
        } else {
          resultSection.classList.add("no-rain");
          resultIcon.textContent = "‚òÄÔ∏è";
          resultTitle.textContent = "TIDAK HUJAN";
          resultDescription.textContent =
            "Prediksi menunjukkan cuaca cerah tanpa hujan";
        }

        // Tampilkan confidence dan probabilitas
        let confidenceHTML = `<strong>Tingkat Kepercayaan: ${confidence.toFixed(
          2
        )}%</strong>`;

        if (probabilities) {
          const LABEL_MAP = {
            Hujan: "Hujan",
            Tidak_Hujan: "Tidak Hujan",
          };

          const ORDER = ["Hujan", "Tidak_Hujan"]; // urutan fix, tidak berdasarkan dictionary JS

          confidenceHTML +=
            '<br><small style="font-size: 12px; margin-top: 8px; display: block; opacity: 0.9;">';
          confidenceHTML += "<strong>Detail Probabilitas:</strong><br>";

          ORDER.forEach((key) => {
            if (probabilities[key] !== undefined) {
              confidenceHTML += `${LABEL_MAP[key]}: ${probabilities[
                key
              ].toFixed(2)}% | `;
            }
          });

          // Hapus pemisah " | " terakhir
          confidenceHTML = confidenceHTML.slice(0, -3);
          confidenceHTML += "</small>";
        }
      }

      /**
       * Show error message
       */
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");

        // Auto hide after 5 seconds
        setTimeout(() => {
          hideError();
        }, 5000);
      }

      /**
       * Hide error message
       */
      function hideError() {
        errorMessage.classList.remove("show");
      }

      // Cek koneksi backend saat halaman dimuat
      async function checkBackendConnection() {
        try {
          const response = await fetch("http://localhost:5000/api/health");
          const result = await response.json();

          if (result.status === "healthy") {
            console.log("‚úì Backend connected successfully");
          }
        } catch (error) {
          console.warn(
            "‚ö† Backend not connected. Make sure Flask server is running at http://localhost:5000"
          );
        }
      }

      // Check backend saat halaman dimuat
      checkBackendConnection();
    </script>
  </body>
</html>
